import vsketch
import math
import random

import numpy as np
from shapely.geometry import *
from shapely.ops import *


def kmeans(pts, k):
    if len(pts) <= k:
        return [[p] for p in pts]

    pivots = [pts[i] for i in range(k)]

    old_clusters = []
    while True:
        clusters = [[] for _ in range(k)]
        for x, y in pts:
            i = min(
                range(k), key=lambda i: math.hypot(pivots[i][0] - x, pivots[i][1] - y)
            )
            clusters[i].append((x, y))

        if clusters == old_clusters:
            break

        pivots = []
        for cluster in clusters:
            cx, cy = 0, 0
            for x, y in cluster:
                cx, cy = cx + x, cy + y

            pivots.append((cx / len(cluster), cy / len(cluster)))

        old_clusters = clusters

    return old_clusters


class Prng:
    def __init__(self, bits, n=32):
        self.bits = bits
        self.ix = 0
        self.n = n

    @staticmethod
    def carrion():
        bits = "1001101011010011101010010111010000111010101101011010100001011010101101011010101001010010010100100101110101010010001001001010100100010001001010010001000100011010101010001000101010101100011110101001011100110101001010101110001010101010101011000100010001001010101001111000111001010100011110001010100110001000100101010101010101110101000101001101010110101101010110101001010100100010101010110011110101010110001110010101011000111001010101100011111000001111000011110000111010000101111010100001011110101011101010010111001101110101010001011110101000101011101010100010101110101110001010110101001010000001010100000010100000010100000010010000000101001111101010111101010110110001110101011111010101111101010111110101011111010101111010101111010101111010100011100001110101010101010010101010101101010110101001010101101010011010100001110011100011001110001100111000111000111000110001110001100011000110000111101000111001000111011000111001110001100110001100010000100010000111000010101010"
        return Prng([int(b) for b in bits])

    @staticmethod
    def chemical():
        bits = "1110001110001010100110110011001010110011001110001110001110101000010001000101010000100001001010100001000100001010100010000100010101000100010001010111101110111010100001000010001010100010001010100100100101010101110101101101101010101001001010100001000010000101111110111110101010000100000001010111101010000101011101111101000010110101000010010101110101000011101000100111010100011101010111010100010100010001010111011001011011011010101010110110101010100111010101000100101010101111111110101011010101101110101011010110101001010010010100110101101010001000100001000101011110111011101010000100101010101111000011110101000111101110101011011010100101000100100010100101000100111010101000011110000101011111000010101010000111101010001100001010101101001010101101011110101101010101101011010110110100101110110101001011101101001010110100100111100001010110110101100111100011101010001111000101011110000111101010000111100001010111100001111010100000000000010101011101"
        return Prng([int(b) for b in bits])

    @staticmethod
    def disconnected():
        bits = "0101101010101101011010010101010011011101110010111011011010101110111011101110000100001111011101110111011101101000111101110111011100011010011010100111010101001100001010111010101010111010111010110100101001010101110101100101000101010101011010100101110101001010101001100001010010100010100100111010100101001010101110111011011010110101010101111111111001011101011101001010111010100111101111011100101010000110011010101010100101001010110101001000100101001010110110000110101001110010100100010101001001000101000110010101110010100010010100100000101010100101001001101001010111010100001001001010101011010100101010010100101011001010010010100100010101010010100101010000000001010100101010100101000011010010101110101011010100010101000010000010101000101010011001010100110001010100101001001011101010100101000000101010011101010010100100001010110110101110111000101011011011101101101001010111001101001010110101011010111001010101010100101011100101000111001010010101100110010101011010000111001010010101101010110010001101010100110011001010110110010100011001010001100010"
        return Prng([int(b) for b in bits])

    @staticmethod
    def random():
        bits = [random.randrange(2) for _ in range(4096 + 17)]
        return Prng(bits)

    def __call__(self, s=None, e=None):
        n = 0
        for i in range(self.n):
            n = n << 1 | self.bits[(self.ix + i) % len(self.bits)]
        self.ix = (self.ix + self.n) % len(self.bits)

        t = n / (2 ** self.n)
        if s is None and e is None:
            return t

        if s is not None and e is not None:
            return s + t * (e - s)

        return t * (s if s is not None else e)


class Day24Sketch(vsketch.SketchClass):
    points = vsketch.Param(30)
    k = vsketch.Param(10)
    triangle_prob = vsketch.Param(0.7, 0, 1)
    song = vsketch.Param(
        "random", choices=["random", "carrion", "chemical", "disconnected"]
    )

    def draw(self, vsk: vsketch.Vsketch) -> None:
        vsk.size("a4", landscape=False)
        vsk.scale("cm")

        rng = getattr(Prng, self.song)()

        pts = [(rng(16), rng(28)) for _ in range(self.points)]

        clusters = kmeans(pts, self.k)

        for cluster in clusters:
            vsk.geometry(MultiPoint(cluster).convex_hull)

            for t in triangulate(MultiPoint(cluster)):
                if rng() < self.triangle_prob:
                    continue

                vsk.geometry(t)

                i = int(rng(3))
                sx, sy = t.boundary.coords[i]

                x1, y1 = t.boundary.coords[(i + 1) % 3]
                x2, y2 = t.boundary.coords[(i + 2) % 3]

                divs = int(rng(5, 30))
                for d in range(divs):
                    k = d / divs
                    a = sx + k * (x1 - sx), sy + k * (y1 - sy)
                    b = sx + k * (x2 - sx), sy + k * (y2 - sy)
                    vsk.line(*a, *b)

    def finalize(self, vsk: vsketch.Vsketch) -> None:
        vsk.vpype("linemerge linesimplify reloop linesort")


if __name__ == "__main__":
    Day24Sketch.display()
